<%- include("header") -%>

<div ng-app="enioApp">
    <div id="divNgController" ng-controller="FirmaController">
        <h2 style="margin-bottom: 25px; color: #2c3e50;">📄 Lista računa za {{ firma.aktivna_godina }}. godinu</h2>
    </div>
</div>

<div class="action-buttons">
    <input type="button" value="➕ Unos novog računa" onclick="window.location.href='/home/racun-edit'" class="btn-success" />
    <input type="button" value="🖨️ Ispis računa" onclick="ispisRacuna();" class="btn-primary" />
    <input type="button" value="📋 Ispis liste računa" onclick="ispisListeRacuna();" class="btn-primary" />
</div>

<div class="filter-section">
    <span>📅 Datum od:</span>
    <input id="datum-od" type="text" placeholder="Odaberite datum" />
    <span>📅 Datum do:</span>
    <input id="datum-do" type="text" placeholder="Odaberite datum" />
</div>

<div class="card" style="padding: 0; overflow: hidden;">
    <table id="RacunTable"></table>
    <div id="RacunTablePager"></div>
</div>

<script type="text/javascript">
    Globalize.culture("hr");

    var filters = "";
    function setFilters(f) {
        filters = f;
    }

    $("#RacunTable").jqGrid({
        url: "/api/racun",
        datatype: "json",
        colNames: ["Id", "Broj", "Partner", "Datum", "Iznos", "Status"],
        colModel: [
            { name: "id", index: "id", hidden: true },
            { name: "broj_racuna", index: "broj_racuna", width: 50, searchoptions: { clearSearch: false } },
            { name: "partner_naziv", index: "partner_naziv", width: 200, searchoptions: { clearSearch: false } },
            { name: "datum", index: "datum", width: 200, formatter: "date", formatoptions: { srcformat: "Y-m-d", newformat: "d.m.Y" }, search: false },
            { name: "iznos", index: "iznos", width: 200, align: "right", formatter: "number", formatoptions: { decimalSeparator: ",", decimalPlaces: 2 }, search: false },
            {
                name: "status_id", index: "status_id", width: 200, stype: "select",
                searchoptions: { sopt: ["eq"], value: ":--;1:Plaćen;2:Neplaćen;3:Storniran;4:Otpis;5:Blokada", clearSearch: false }
            },
        ],
        pager: "#RacunTablePager",
        caption: "Lista računa",
        onSelectRow: function (id) {
            var rowData = $(this).getRowData(id);
            var racunGlavaId = rowData["id"];
            window.location.href = "/Home/racun-edit?racunGlavaId=" + racunGlavaId;
        },
            height: 400,
            rowNum: 20
    }).filterToolbar({
        groupOp: "AND",
        stringResult: true,
        searchOnEnter: false,
        beforeSearch: function () {
            var $grid = $('#RacunTable');
            var postData = $grid.jqGrid('getGridParam', 'postData');
            var filters = $.parseJSON(postData.filters);

            addDateFilter("datum-od", filters, "ge");
            addDateFilter("datum-do", filters, "le");

            if (filters && filters.rules && filters.rules.length > 0) {
                for (var i = 0; i < filters.rules.length; i++) {
                    var rule = filters.rules[i];

                    if (rule.field === "status.name") {
                        rule.field = "status_id";
                    }
                }

                postData.filters = JSON.stringify(filters);
                setFilters(postData.filters);
            }
        }
    });;

    function addDateFilter(dateField, filters, operator) {
        var dateString = $("#" + dateField).val();

        if (dateString) {
            var date = Globalize.parseDate(dateString);

            if (date) {
                var param = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
                filters.rules.push({ field: "datum", data: date, op: operator });
            }
        }
    }

    $(document).on("FirmaIsLoaded", function () {
        ngControllerScope = angular.element($("#divNgController")).scope();

        $("#datum-od, #datum-do").datepicker({
            yearRange: ngControllerScope.firma.AktivnaGodina + ":" + ngControllerScope.firma.AktivnaGodina,
            changeMonth: true,
            changeYear: true,
            onSelect: function (dateText) {
                $("#RacunTable")[0].triggerToolbar();
            }
        });
    });

    $("#datum-od, #datum-do").change(function () {
        $("#RacunTable")[0].triggerToolbar();
    });

    function ispisRacuna() {
        window.open("/Home/RacunReportCollection?jqGridFilters=" + encodeURIComponent(filters));
    }

    function ispisListeRacuna() {
        window.open("/Home/RacunReportCollectionAsList?jqGridFilters=" + encodeURIComponent(filters));
    }
    
    // Fix height issues after grid loads
    $("#RacunTable").bind("jqGridAfterLoadComplete", function() {
        var bdiv = $(this).closest('.ui-jqgrid-bdiv');
        var innerDiv = bdiv.find('> div[style*="position"]');
        innerDiv.css({'height': 'auto', 'min-height': '0'});
        bdiv.css({'height': 'auto', 'max-height': 'none'});
    });
</script>


<%- include("footer") -%>